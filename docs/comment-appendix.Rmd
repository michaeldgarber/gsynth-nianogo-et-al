---
title: "Appendix for comment on Nianogo et al."
author: "Michael D. Garber"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r,eval=T, echo=F,warning=FALSE, message=F}
library(here)
library(tidyverse)
library(mapview) #for interactive mapping
library(tmap) #static mapping
library(sf) #for managing spatial data
library(gsynth) #to run the generalized synthetic control method
library(RColorBrewer) #for creating color palettes
```

# Intro 
This appendix contains supporting information and code related to my comment on Nianogo et al.'s article.

The R Markdown file that creates this web page is located here:
https://github.com/michaeldgarber/gsynth-nianogo-et-al/blob/main/docs/comment-appendix.Rmd


The authors provide their data and code here:
https://anonymous.4open.science/r/Medicaid-CVD-Disparities-4CB7/README.md

I've done some additional processing to that data in the scripts located in this folder:
https://github.com/michaeldgarber/gsynth-nianogo-et-al/tree/main/scripts

They can be run in the following order:
```{r, eval=F, echo=T,warning=FALSE, message=F}
source(here("scripts", "read-wrangle-data-acs.R"))
source(here("scripts", "read-wrangle-data-pres-election.R"))
source(here("scripts", "read-wrangle-data-nianogo-et-al.R"))
```


# Explore data
```{r, eval=T, echo=F,warning=FALSE, message=F}
#Load the data. Don't show this code chunk in the html.
#Note these data are created here:
setwd(here("data","data-processed"))
load("black_complete.RData")
load("hispanic_complete.RData")
load("black_complete_geo.RData")
load("hispanic_complete_geo.RData")
load("white.RData")
load("overall.RData")
load("overall_geo.RData")
load("overall_covars_alt.RData")
load("lookup_state_abb_geo.RData")
load("lookup_state_abb_geo_simplify_shift_al_hi.RData")
```

## Medicaid expansion and missingness
In this section, I explore Medicaid expansion status by missingness status in the demographic groups.

### Medicaid expansion (all states, 2019)
This map shows Medicaid expansion status of states in 2019.
```{r,eval=T, echo=F, warning=FALSE, message=F}
overall %>%
  filter(year==2019) %>% 
  group_by(treated) %>% 
  summarise(n=n()) %>% 
  knitr::kable(caption="Medicaid expansion status (2019)")
```

```{r,eval=T, echo=F, warning=FALSE, message=F}
#Create color palettes for maps
pal_puor_4=brewer.pal(name="PuOr",n=4)
pal_puor_4_subset=pal_puor_4[c(1,2,4)]
pal_puor_4_reorder = c(pal_puor_4_subset,pal_puor_4[3])
pal_puor_2=pal_puor_4_reorder[c(1,3)]
#pal_puor_2 %>% swatch()

lookup_state_abb_geo_simplify_shift_al_hi %>% 
  left_join(overall_covars_alt,by="state_abb") %>% 
  filter(year==2019) %>% 
  mutate(treated_y_n=case_when(
    treated==1~"Yes",
    TRUE ~"No")) %>% 
  tm_shape()+
  tm_fill(
    "treated_y_n",
    palette = pal_puor_2,
    title="Medicaid expansion status (2019)")+
  tm_borders(col="black",alpha=.5)+
  tm_layout(
    frame=F,
    legend.outside=T,
    legend.outside.position="bottom"
  )
```


### Hispanic population
```{r,eval=T, echo=F,warning=FALSE, message=F}
#Number of non-missing states
hispanic_complete %>%
  filter(year==2019) %>% 
  group_by(treated) %>% 
  summarise(n=n()) %>% 
  knitr::kable(caption="Medicaid expansion status (2019) among states with non-missing CVD data for the Hispanic population")

lookup_state_abb_geo_simplify_shift_al_hi %>% 
  left_join(overall_covars_alt,by="state_abb") %>% 
  filter(year==2019) %>% 
  tm_shape()+
  tm_fill(
    "treated_post_hispanic_miss",
    palette=pal_puor_4_reorder,
    title="Medicaid expansion status (2019) by missingness in Hispanic data")+
  tm_borders(col="black",alpha=1)+
  tm_layout(
    frame=F,
#    legend.title.size=.5,
    legend.outside=T,
    legend.outside.position="bottom"
    )

```

### Black population
```{r,eval=T, echo=F, warning=FALSE, message=F}
black_complete %>%
  filter(year==2019) %>% 
  group_by(treated) %>% 
  summarise(n=n()) %>% 
  knitr::kable(caption="Medicaid expansion status (2019) among states with non-missing CVD data for the Black population")

lookup_state_abb_geo_simplify_shift_al_hi %>% 
  left_join(overall_covars_alt,by="state_abb") %>% 
  filter(year==2019) %>% 
  tm_shape()+
  tm_fill(
    "treated_post_black_miss",
    palette=pal_puor_4_reorder,
    title="Medicaid expansion status (2019) by missingness in Black data")+
  tm_borders(col="black",alpha=1)+
  tm_layout(
    frame=F,
#    legend.title.size=.5,
    legend.outside=T,
    legend.outside.position="bottom"
    )

```

## Distribution of BRFSS covariates
In this section, I examine the distribution of some of the BRFSS covariates used in the analysis to see if the BRFSS data may be contributing to the instability of the effect estimates.

### Proportion men
#### All adults aged 45-64
Proportion men among all adults aged 45-64 (dataset name: overall)
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(overall$male)
overall %>% 
  ggplot(aes(x=male))+
  geom_histogram()+
  theme_bw()
```

#### Hispanic adults aged 45-64
Proportion men among Hispanic adults aged 45-64 (dataset name: hispanic_complete)

Observation: some state-years have 0% or 100% men in this group, which is not plausible, highlighting the fact that BRFSS may not be reliable in such stratified sub-groups.
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(hispanic_complete$male)
hispanic_complete %>% 
  ggplot(aes(x=male))+
  geom_histogram()+
  theme_bw()
```

In California, most years seem implausibly low.
```{r,eval=T, echo=F, warning=FALSE, message=F}
hispanic_complete %>% 
  filter(state_abb=="CA") %>% 
  ggplot(aes(y=male,x=year))+
  geom_line()+
  theme_bw()
```

#### Black adults aged 45-64
Again, the proportion men among Black adults aged 45-64 seems implausible in some state-years.
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(black_complete$male)
black_complete %>% 
  ggplot(aes(x=male))+
  geom_histogram()+
  theme_bw()
```

#### White adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(white$male)
white %>% 
  ggplot(aes(x=male))+
  geom_histogram()+
  theme_bw()
```

### Low income
Less than $15,000

#### All adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(overall$low_income)
overall %>% 
  ggplot(aes(x=low_income))+
  geom_histogram()+
  theme_bw()
```


#### Hispanic adults aged 45-64
Again, there are what I would think are some implausible observations (e.g,. 0% or 100% low income in a state-year).
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(hispanic_complete$low_income)
hispanic_complete %>% 
  ggplot(aes(x=low_income))+
  geom_histogram()+
  theme_bw()
```

#### Black adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(black_complete$low_income)
black_complete %>% 
  ggplot(aes(x=low_income))+
  geom_histogram()+
  theme_bw()
```

#### White adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(white$low_income)
white %>% 
  ggplot(aes(x=low_income))+
  geom_histogram()+
  theme_bw()
```

### Low education
No high-school degree
#### All adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(overall$low_educ)
overall %>% 
  ggplot(aes(x=low_educ))+
  geom_histogram()+
  theme_bw()
```


#### Hispanic adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(hispanic_complete$low_educ)
hispanic_complete %>% 
  ggplot(aes(x=low_educ))+
  geom_histogram()+
  theme_bw()
```

#### Black adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(black_complete$low_educ)
black_complete %>% 
  ggplot(aes(x=low_educ))+
  geom_histogram()+
  theme_bw()
```

#### White adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(white$low_educ)
white %>% 
  ggplot(aes(x=low_educ))+
  geom_histogram()+
  theme_bw()
```


### Married

#### All adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(overall$married)
overall %>% 
  ggplot(aes(x=married))+
  geom_histogram()+
  theme_bw()
```


#### Hispanic adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(hispanic_complete$married)
hispanic_complete %>% 
  ggplot(aes(x=married))+
  geom_histogram()+
  theme_bw()
```

#### Black adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(black_complete$married)
black_complete %>% 
  ggplot(aes(x=married))+
  geom_histogram()+
  theme_bw()
```

#### White adults aged 45-64
```{r,eval=T, echo=F, warning=FALSE, message=F}
summary(white$married)
white %>% 
  ggplot(aes(x=married))+
  geom_histogram()+
  theme_bw()
```

### Political orientation and considering an alternative measure
In Nianogo et al.'s Table 1, they present the measure of political-party affiliation in 2014.
The below replicates those values, where 0=Republican, 1=Democrat, and 2=Split.

```{r,eval=T, echo=F, warning=FALSE, message=F}
overall %>% 
  filter(year==2014) %>% 
  group_by(party) %>% 
  summarise(
    n=n()) %>% 
  ungroup() %>% 
  mutate(
    n_total=sum(n),
    prop=n/n_total
    ) %>% 
  knitr::kable()
```

To facilitate interpretation, this variable in 2016 is mapped here:
```{r,eval=T, echo=F, warning=FALSE, message=F}
lookup_state_abb_geo_simplify_shift_al_hi %>% 
  left_join(overall_covars_alt,by="state_abb") %>% 
  filter(year==2016) %>%
  mutate(
    party_overall_char=case_when(
      party_overall==0~"Republican",
      party_overall==1~"Democrat",
      party_overall==2~"Split"
  )) %>% 
  tm_shape()+
  tm_fill(
    "party_overall_char",
    palette=c("#67a9cf","#ef8a62","#af8dc3"),
    title="Political party variable (2016)"
)+
  tm_borders(col="black",alpha=.5)+
  tm_layout(
    frame=F,
    legend.outside=T,
    legend.outside.position="bottom"
  )

```

These values struck me as somewhat odd. For one, it appears a given state-year receives a value of either Republican, Democrat, or split, raising the question of within-state variability in the measure. Second, given the polarization and parity of party politics in the United States, I would expect the values corresponding to Republican (0) and Democrat (1) to be about the same and for both to be nearer to 50%.

A simpler and more stable (in terms of sampling variability) measure for the state's political environment might be the popular-vote share from presidential elections. Those data are available here:

https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/42MVDX

In this script, I've loaded popular-vote data from presidential elections.
```{r,eval=F}
source(here("scripts", "read-wrangle-data-pres-election.R"))
```

In analyses as presented in Scenarios 2-5 in the main text, I applied the vote share from the most recent election if the year wasn't an election year. For example, 2014 received 2012's popular-vote data.


# Use state-year effect estimates from the gsynth function to calculate summary measures of effect
In this section, I use state-year effect estimates to calculate the summary measures of effect in the main text's table.

This code will populate values for Scenario 5 in the table in which we used the MC-. Code for the other analyses can be found here:
gsynth-nianogo-et-al/scripts/gsynth-analyses-to-post.R

## Load the data
```{r, eval=F, echo=T,warning=FALSE, message=F}
source(here("scripts", "read-wrangle-data-acs.R"))
source(here("scripts", "read-wrangle-data-pres-election.R"))
source(here("scripts", "read-wrangle-data-nianogo-et-al.R"))
```

```{r, eval=T, echo=F,warning=FALSE, message=F}
#Load the gsynth output in the background
setwd(here("data","data-processed"))
load("gsynth_out_overall_sub_pol_mc_nnm.RData")
```

## Run the gsynth function

Here, I will summarize effects estimated by the MC-NNM estimator as presented in Scenario 5 of the table in the text.
Also see
https://yiqingxu.org/packages/gsynth/articles/tutorial.html#matrix-completion

```{r, eval=F, echo=T,warning=FALSE, message=F}
gsynth_out_overall_sub_pol_mc_nnm=gsynth(
  #outcome ~ treatment indicator+ covariates
  cvd_death_rate ~ treatedpost + 
    primarycare_rate +
    cardio_rate + 
    population_overall + 
    low_educ_overall + 
    married_overall+ 
    employed_for_wages_overall + 
    vote_share_dem+#popular vote data
    low_income_overall + 
    male_overall + 
    race_nonwhite_overall
  ,

  #dataset in which the effects are estimated
  data = overall_covars_alt,
  estimator = "mc", #the MC-NNM estimator
  #      EM = F, #
  index = c("state_id","year"), #time-unit
  
  #non-parametric bootstrap if MC-NNM estimator used
  #inference = "parametric", 
  se = TRUE, 
  
  #perform a cross-validation procedure to 
  #determine the number of unobserved factors
  CV = TRUE, 

  #the range of possible numbers of unobserved factors
  r = c(0, 5), #
  seed = 123, #arbitrary seed so same results every time
  nboots = 2000, #number of bootstrap reps
  force = "two-way", 
  parallel = TRUE
)
```


## Examine summary output returned by the gsynth function
Return the average (unweighted) difference effect over all treated state-years and the corresponding standard error and confidence intervals.
```{r}
gsynth_out_overall_sub_pol_mc_nnm$est.avg
```

These confidence intervals are calculated by adding 1.96*SE and -1.96*SE to either side of the estimate.
```{r}
#qnorm(.975)#return the exact value
#Estimate
gsynth_out_overall_sub_pol_mc_nnm$est.avg[1]

#Upper limit
gsynth_out_overall_sub_pol_mc_nnm$est.avg[1]+
  gsynth_out_overall_sub_pol_mc_nnm$est.avg[2]*1.959964

#Lower limit
gsynth_out_overall_sub_pol_mc_nnm$est.avg[1]-
  gsynth_out_overall_sub_pol_mc_nnm$est.avg[2]*1.959964
```

Another way to return the average treatment effect without the confidence intervals
```{r}
gsynth_out_overall_sub_pol_mc_nnm$att.avg
```

The average treatment effect at each time point can be returned by `gsynth_object$att`. These effect estimates are summarized over units where time is scaled to the treatment period for that unit. That is, 1 corresponds to the first treated year for each treated state, regardless of the calendar year.
```{r}
gsynth_out_overall_sub_pol_mc_nnm$att
```

## Return effect estimates for every treated state-year
Using the effect estimates for every treated state-year, we can replicate the summary difference effects presented above.

Here are the difference effects for all state-years. Note that "effects" are estimated for all state-years in the treated states, including pre-treatment years. Pre-treatment effects are the difference between the observed and predicted counterfactual outcomes before treatment.
```{r}
gsynth_out_overall_sub_pol_mc_nnm$eff
```


